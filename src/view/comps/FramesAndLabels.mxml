<?xml version="1.0" encoding="utf-8"?>
<!-- zengrong.net -->
<!-- 创建者:zrong(zrongzrong@gmail.com) -->
<!-- 创建时间：2011-8-17 -->
<!-- 管理帧和Label -->
<s:BorderContainer xmlns:fx="http://ns.adobe.com/mxml/2009" 
		  xmlns:s="library://ns.adobe.com/flex/spark"
		  currentState="{labelCB.selected?'frameAndLabel':'frame'}">
	<s:layout>
		<s:VerticalLayout horizontalAlign="center" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5"/>
	</s:layout>
	<fx:Metadata>
		[Event(name="frameAndLabelChange", type="events.SSEvent")]
		[Event(name="selectedFrameIndicesChange", type="events.SSEvent")]
	</fx:Metadata>
	<s:states>
		<s:State name="frame"/>
		<s:State name="frameAndLabel"/>
	</s:states>
	<s:Label id="frameLabel" fontWeight="bold" text="{labelList.selectedItem?('LABEL('+labelList.selectedItem.name+')中的帧:'+frameAC.length):'所有可用帧:'+frameAC.length}"/>
	<s:HGroup verticalAlign="middle" width="100%">
		<s:Button id="addSSBTN" width="100%" label="增加SpriteSheet"
				  toolTip="添加一个或多个SpriteSheet到当前Sheet的末尾。规则如下：&#13;1.所有帧会增加到当前Sheet的末尾；&#13;2.若label重名，则被导入Sheet中的label不导入，但依然会导入该lable的所有帧；&#13;3.若name重名，则被导入的Sheet中该name对应的重名帧不会被导入；&#13;4.若原始Sheet中包含name，但被导入Sheet中不含name，则会自动为被导入的Sheet中的所有帧命名。"/>
		<s:Button id="addPicBTN" width="100%" label="增加图像帧"
				  toolTip="添加多个图像文件。每个图像作为一帧增加到当前Sheet的末尾。"/>
	</s:HGroup>
	<s:HGroup verticalAlign="middle" width="100%">
		<s:Button id="delBTN" label="删帧" width="100%" enabled="{frameDG.selectedItem&amp;&amp;!playing}" 
				  toolTip="从帧列表中删除一帧。删除后会立即更新Sheet。"/>
		<s:Button id="prevBTN" label="上帧" width="100%" enabled="{frameDG.selectedItem&amp;&amp;!playing&amp;&amp;frameDG.selectedIndex>0}" 
				  click="prevFrame();"/>
		<s:Button id="nextBTN" label="下帧" width="100%" enabled="{frameDG.selectedItem&amp;&amp;!playing&amp;&amp;frameDG.selectedIndex&lt;frameAC.length-1}" 
				  click="nextFrame();"/>
		<s:Button id="allBTN" width="100%" label="全选" enabled="{frameAC&amp;&amp;frameAC.length>0}"
				  click="handler_allBTNclick(event)"/>
	</s:HGroup>
	<s:DataGrid id="frameDG" width="100%" height="200" dataProvider="{frameAC}"
				selectionMode="multipleRows" sortableColumns="false"
				valueCommit="handler_frameDGValueCommit(event)">
		<s:columns>
			<s:ArrayList>
				<s:GridColumn headerText="帧号" width="40" dataField="frameNum"/>
				<s:GridColumn headerText="名称" width="60" dataField="frameName"/>
				<s:GridColumn headerText="修剪尺寸" dataField="frameSize"/>
				<s:GridColumn headerText="原始尺寸" dataField="originSize"/>
			</s:ArrayList>
		</s:columns>
	</s:DataGrid>
	<s:HGroup width="100%" verticalAlign="middle">
		<s:CheckBox id="labelCB" label="使用Label"/>
		<s:TextInput id="labelInput" includeIn="frameAndLabel" width="100%"
					 text="{labelList.selectedItem.label}"
					 toolTip="label格式：英文+数字"/>
	</s:HGroup>
	<s:HGroup width="100%" verticalAlign="middle" includeIn="frameAndLabel" itemCreationPolicy="immediate">
		<s:Button id="addLabelBTN" width="100%" label="加Label"
				  enabled="{frameDG.selectedItem &amp;&amp; labelInput.text}" toolTip="添加一个Label到列表中"/>
		<s:Button id="removeLabelBTN" width="100%" label="删Label"
				  enabled="{labelList.selectedItem}"
				  toolTip="删除选中的Label"/>
		<s:Button id="renameBTN" width="100%" label="改Label" 
				  click="handler_renameBTNclick(event)"
				  enabled="{labelInput.text&amp;&amp;labelList.selectedItem}" toolTip="修改Label名称"/>
		<s:Button id="cancelBTN" width="100%" label="取消选择" enabled="{labelList.selectedItem}" 
				  click="labelList.selectedIndex=-1;"/>
	</s:HGroup>
	<s:List id="labelList" width="100%" height="150" dataProvider="{labelAL}"
			labelField="name" includeIn="frameAndLabel" itemCreationPolicy="immediate"/>
	<fx:Script>
	<![CDATA[
		import events.SSEvent;
		
		import model.FileProcessor;
		
		import mx.collections.ArrayCollection;
		import mx.collections.ArrayList;
		import mx.collections.IList;
		import mx.events.FlexEvent;
		
		import org.zengrong.assets.Assets;
		import org.zengrong.assets.AssetsEvent;
		import org.zengrong.assets.AssetsProgressVO;
		import org.zengrong.assets.AssetsType;
		import org.zengrong.display.spritesheet.SpriteSheet;
		import org.zengrong.display.spritesheet.SpriteSheetMetadata;
		import org.zengrong.display.spritesheet.SpriteSheetMetadataType;
		import org.zengrong.events.InfoEvent;
		
		import spark.collections.Sort;
		import spark.collections.SortField;
		import spark.events.IndexChangeEvent;
		
		import utils.Funs;
		import utils.Global;
		
		import vo.FrameVO;
		import vo.LabelVO;
		
		[Bindable] public var labelAL:ArrayList;
		[Bindable] public var frameAC:ArrayCollection;
		[Bindable] public var selectedFrameNum:int;		//当前选择的帧编号
		[Bindable] public var selectedFrameIndices:Vector.<int>;	//frameDG中选择的索引
		[Bindable] public var playing:Boolean;	//是否正在播放动画。如果是播放动画状态，那么valueCommit的时候，就不更新selectedFrameIndices的值

		/**
		 * 当前正在播放的帧在selectedFrameIndices中的索引
		 */
		private var _currentIndex:int=-1;
		
		public function get selectedFrameIndex():int
		{
			if(frameDG.selectedItem)
				return FrameVO(frameDG.selectedItem).frameNum;
			return -1;
		}
		
		public function init():void
		{
	
		}
		
		public function destroy():void
		{
			trace('FrameAndLabels.destroy');
			if(labelAL)	labelAL.removeAll();
			labelAL = null;
			if(frameAC)	frameAC.removeAll();
			frameAC = null;
			selectedFrameIndices = null;
			selectFrameChange();
			pause();
		}
		
		public function play():void
		{
			playing = true;
			_currentIndex = 0;
		}
		
		public function pause():void
		{
			playing = false;
			_currentIndex = -1;
		}
		
		public function prevFrame():void
		{
			if(frameDG.selectedIndex > 0)
				frameDG.selectedIndex --;
		}
		
		public function nextFrame():void
		{
			trace('nextFrame:', playing, frameDG.selectedIndex, selectedFrameIndices);
			if(playing)
			{
				frameDG.selectedIndex = selectedFrameIndices[_currentIndex];
				if(_currentIndex == -1 || _currentIndex == selectedFrameIndices.length-1)
					_currentIndex = 0;
				else
					_currentIndex ++;
			}
			else
			{
				if(frameDG.selectedIndex < frameAC.length-1)
					frameDG.selectedIndex ++;
				else
					frameDG.selectedIndex = frameAC.length-1;
			}
			
		}
		
		/**
		 * 获取metadata中需要的label数据
		 */
		public function getLabels():Object
		{
			var __hasLabel:Boolean = labelCB.selected && labelAL.length>0;
			if(__hasLabel)
			{
				var __labels:Vector.<String> = new Vector.<String>(labelAL.length, true);
				var __labelsFrame:Object = {};
				var __labelItem:LabelVO = null;
				for (var i:int = 0; i < labelAL.length; i++) 
				{
					__labelItem = labelAL.getItemAt(i) as LabelVO;
					__labels[i] = __labelItem.name;
					__labelsFrame[__labelItem.name] = __labelItem.getFramesIndex();
				}
				return {hasLabel:__hasLabel, labels:__labels, labelsFrame:__labelsFrame};
			}
			return {hasLabel:__hasLabel};
		}
		
		//----------------------------------------
		// 内部方法
		//----------------------------------------
		
		public function selectFrameChange():void
		{
			this.dispatchEvent(new SSEvent(SSEvent.SELECTED_FRAMEINDICES_CHANGE, selectedFrameIndices));
		}
		
		/**
		 * 将帧信息中保存的大于$frameNum的帧的索引减1
		 */
		public function refreshFrameNum($list:IList, $frameNum:int):void
		{
			trace('refreshFrameNum:', $list.length, $frameNum);
			//删除了1帧，就要将帧信息中保存的大于此帧索引的帧的索引减1
			for (var i:int = 0; i < $list.length; i++) 
			{
				var __item:FrameVO = $list.getItemAt(i) as FrameVO;
				if(__item.frameNum>$frameNum)
				{
					__item.frameNum --;
					$list.setItemAt(__item, i);
				}
			}
		}
		
		//----------------------------------------
		// handler
		//----------------------------------------
		
		protected function handler_frameDGValueCommit($event:FlexEvent):void
		{
			//只有不在播放状态，才更新选择的帧列表
			if(!playing)
			{
				selectedFrameIndices = frameDG.selectedIndices.concat();
				//获取到的Vector是降序的，倒转它
				selectedFrameIndices.sort(Array.NUMERIC);
				trace('更新indices:', selectedFrameIndices);
				selectFrameChange();
			}
			selectedFrameNum = frameDG.selectedIndex==-1?-1:FrameVO(frameDG.selectedItem).frameNum;
			trace('dgValueCommit:', selectedFrameNum, addLabelBTN);
			dispatchEvent(new SSEvent(SSEvent.FRAME_AND_LABEL_CHANGE));
		}
		
		protected function handler_renameBTNclick($event:MouseEvent):void
		{
			var __item:Object = labelAL.getItemAt(labelList.selectedIndex);
			__item.name = labelInput.text;
			labelAL.setItemAt(__item, labelList.selectedIndex);
		}

		protected function handler_allBTNclick($event:MouseEvent):void
		{
			var __indics:Vector.<int> = new Vector.<int>;
			for (var i:int = 0; i < frameAC.length; i++) 
			{
				__indics[i] = i;
			}
			frameDG.selectedIndices = __indics;
		}
	]]>
	</fx:Script>
</s:BorderContainer>
